from audioop import error
from forms import LoginForm
import bcrypt
from flask import Flask, g, jsonify,render_template, request,url_for,flash,redirect
import psycopg2
from flask_bcrypt import Bcrypt
from flask_sqlalchemy import SQLAlchemy
from forms import RegistrationForm
import jwt
import datetime
import os
import psycopg2
from flask import Flask, request, jsonify
from flask_bcrypt import Bcrypt
app = Flask(__name__)
bcrypt = Bcrypt(app)

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'postgresql://postgres:GNanthu$2001@localhost/password'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)
bcrypt= Bcrypt(app)
app.config['SECRET_KEY']='33c7a01f8988502409176555d933e603'





def get_db():
    if "db" not in g:
        g.db = psycopg2.connect(
            host="Localhost",
            database="password",
            user="postgres",
            password="GNanthu$2001",
        )
    return g.db


def get_cursor():
    if "cursor" not in g:
        g.cursor = get_db().cursor()
    return g.cursor


@app.before_request
def before_request():
    get_db()
    get_cursor()


@app.teardown_request
def teardown_request(exception):
    db = g.pop("db", None)
    if db is not None:
        db.close()
    cursor = g.pop("cursor", None)
    if cursor is not None:
        cursor.close()

@app.route('/login', methods=['POST'])
def login():
    cur = get_cursor()
    if request.method == 'POST':
        req_data = request.get_json()
        if not req_data:
            return jsonify(message="No JSON data provided"), 400

        required_fields = ['email', 'password']
        for field in required_fields:
            if field not in req_data:
                return jsonify(message=f"{field} is required"), 400

        new_data = {
            'email': req_data['email'],
            'password': req_data['password']
        }

        conn = None
        try:
            cur = conn.cursor()
            cur.execute("SELECT password FROM users WHERE email = %s", (new_data['email'],))
            result = cur.fetchone()
            conn.close()

            if result is None:
                return jsonify(message="Login unsuccessful. Email address not found."), 401

            password_hash = result[0]
            password_str = str(new_data['password'])

            if bcrypt.check_password_hash(password_hash, password_str):
                return jsonify(message="Login successful."), 200
            else:
                return jsonify(message="Login unsuccessful. Incorrect password."), 401

        except (Exception, psycopg2.Error) as error:
            print(f"Error during login: {error}")
            return jsonify(message="Login unsuccessful. Please try again later."), 500
        

@app.route('/registers', methods=['POST'])
def create_user():
    cur = get_cursor()
    if request.method == 'POST':
        req_data = request.get_json()
        if not req_data:
            return jsonify(message="No JSON data provided"), 400

        required_fields = ['username', 'email', 'password']
        for field in required_fields:
            if field not in req_data:
                return jsonify(message=f"{field} is required"), 400
        
        new_data = {
            'username': req_data['username'],
            'email': req_data['email'],
            'password': req_data['password'],
           
        }
        conn = None
        try:
           
            cur.execute(
                "SELECT id FROM users WHERE email = %s",
                (new_data['email'],)
            )
            result = cur.fetchone()

            if result is not None:
                return jsonify(message="email already exists"), 409

            password_hash = bcrypt.generate_password_hash(new_data['password']).decode('utf-8')

            cur.execute(
                "INSERT INTO users (username, email, password) VALUES (%s, %s, %s)",
                (new_data['username'], new_data['email'], password_hash)
            )
            get_db().commit()

            
            expires_in = datetime.timedelta(days=1)
            token_data = {
                'user_id': cur.lastrowid,
                'exp': datetime.datetime.utcnow() + expires_in
            }
            token = jwt.encode(token_data, app.config['33c7a01f8988502409176555d933e603'], algorithm='HS256')
            return jsonify(message="Your account was created successfully", token=token), 201

        except Exception as e:
            print(f"Error creating user: {e}")
            return jsonify(message="Failed to create user"), 500

        finally:
            if conn is not None:
                conn.close()

    else:
        return jsonify(message="Invalid method"), 405

if __name__ =='__main__':
    app.run(debug=True)
